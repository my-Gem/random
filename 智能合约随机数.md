## 智能合约随机数生成

### 生成随机数的评测标准

1)随机、不可预测：要求产生独立、均匀分布的杂乱数据，并且参与生成随机数的任何一方都无法单独预测结果

2)不可选择：要求生成的随机数对给定种子是唯一的，生产者不能生成一系列的随机数并选择对自己有利的发布出去

3)不可隐瞒：要求生成的随机数无法被隐瞒或撤回

4)成本／响应速度的要求





 

### 常见生成的方法

#### =>纯链上信息做种子生成伪随机数  

```
●	block.coinbase: 挖出当前块的矿工地址
●	block.diffuculty: ...
●	block.number: ...
●	block.timestamp: ...
●	blockhash(uint blockNumber):
○	blockhash(block.number)	=>	0x0
○	blockhash(最近的256个块) =>  除去当前块的最近256个区块哈希


❗由于在同一个块内所有交易获得的区块信息相同，可以通过部署链上合约的方式来“预测”随机数。
```

##### 例子:fomo3D

![](http://pminer.oss-cn-shenzhen.aliyuncs.com/news/20200220131756.png)

http://pminer.oss-cn-shenzhen.aliyuncs.com/news/20200220131756.png



#### =>庄家用私钥对用户发送的消息签名作为随机数

#### 例子1：BetDice - 玩家贡献种子，庄家用私钥签名来生成随机数

1. 玩家发送一笔下注交易到合约，下注交易包含玩家猜测的骰子数(rollUnder)、下注金额和玩家种子。

2. 庄家监测合约状态，在确认合约收到下注之后，庄家用私钥对消息 sha256(”下注id : 用户名 : 玩家种子”) 来签名，发送开奖交易到合约，用生成的签名作为合约开奖的随机数依据。

 

BetDice声称这种方式产生的随机数“可验证公平” - 玩家可以用庄家公布的公钥、自己的种子和下注id来验证签名；随机数用到了链外私密信息(庄家私钥)，不会被链上攻击合约预测。

 

EOS/ETH普遍使用ECDSA签名算法 (on secp256k1 curve)，而ECDSA不是确定性签名算法：即对同一个消息msg用同一个私钥去签名，每次能得到不同的签名，同时都能被匹配的公钥验证。

 

#### 例子2:

<https://github.com/pertsev/web3_utilz/tree/master/ECDSA%20signature%20generating%20(cheating)>



生成的随机数的特性：

不满足“不可选择”的特性 - 对某些赌注／赔率特别高的下注，庄家可以作弊：在server端持续对消息签名直到得到满足自己要求的签名结果作为随机数，用户还完全没法验证这一点。

不满足“不可隐藏”的特性 - 见下一个例子

目前市面上通过用庄家私钥对玩家种子签名得到“可验证公平”随机数的博彩类游戏普遍具有这个问题。





###  正确生成随机数的方法

#### 1)门限组签名

● 整个系统里有许多个组存在，一个组有n个成员。

● 初始化:每个组有一个逻辑上的私钥SK，而每个成员 i 只拥有这个逻辑私钥的一部分SK_i，完整的私钥SK不存在于任何人手中，也没有公开出来，谁也不知道。每个组员的私钥碎片SK_i在形成组的时候通过分布式秘密分享算法(Distributed Secret Share)方式得到。

●对某个消息Msg用逻辑私钥签名得到逻辑组签名记为Sig；每个组的组公钥PK是公开的。

●签名时:每个成员用自己的私钥碎片SK_i 对消息Msg签名得到签名碎片Sig_i并把签名碎片广播给其他组员；而任意一个组员收集到了任意>= t个(包含自己)签名碎片就能够计算出完整的组签名Sig。

●验证时:存在合约里的组公钥PK可以验证某成员上传的签名Sig’是不是对Msg的有效组签名 - 只要

逻辑私钥SK没有泄漏，如果验证通过表明至少有(t / n x 100%)的组员参与签名过程并同意。



#### 2)通过预言机导入

##### =>DOS Network

DOS (Decentralized Oracle Service) Network 是一个支持多链的去中心化预言机网络，支持链上合约获取互联网上的所有数据。 同时驱动网络节点和组的随机源完全实现了前面所说的门限组签名和链上签名验证，并且提供了链上接口给其他合约调用链外API和请求安全的随机数。目前已经在以太的Rinkeby测试网发布alpha版本



##### =>Chainlink

Chainlink 也是一个支持多链的去中心化预言机网络，支持链上合约获取互联网上的所有数据。

chainlink与[Random.org的API](https://www.random.org/)有专门的连接。chainlink将检索一个随机数以返回您的智能合约。

PS：*[Random.org](https://www.random.org/)*是一个基于大气噪声生成随机数的网站。除了生成指定范围内并服从指定概率分布的随机数（这是网站上最常进行的活动）之外，它还具有免费的工具来模拟掷硬币，洗牌和掷骰子等事件。它还提供付费服务，以生成更长的随机数序列，并充当抽奖，抽奖和促销活动的第三方仲裁者。



## 个人总结

**dos network有实现门限组签名，还有它也就是在以太坊Rinkeby测试网测试,还未在正式网络使用,调用预言机需要消耗Token,dos network也并未提供这方面的文档，dos network现在的工作一直停滞,个人建议不使用dos work**

**chainlink是有大佬站台,有多个去中心化预言机,token已经发行，可正式使用,链下随机数就由联盟连的几个节点提供,chainlink现在还不支持井通链而已，如果想支持井通链需要联系他们的BD部门,可以定制化**

**如果使用[Random.org](https://www.random.org/)提供的api,可靠性还有待验证**